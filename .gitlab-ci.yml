image: node:latest

stages:
  - setup
  - build
  - test
  - deploy

cache:
  untracked: true
  key: "$CI_BUILD_REF_NAME"
  paths:
    - node_modules/

install:
  stage: setup
  script:
    - npm install
  cache:
    untracked: true
    key: "$CI_BUILD_REF_NAME"
    paths:
      - node_modules/
  artifacts:
    paths:
      - node_modules/

build-app:
  stage: build
  script:
    - npm run build
  dependencies:
    - install
  cache:
    key: "$CI_BUILD_REF_NAME"
    paths:
      - node_modules/
    policy: pull
  artifacts:
    paths:
      - dist/

build-lib:
  stage: build
  script:
    - npm install
    - npm run build:lib
  dependencies:
    - install
  cache:
    untracked: true
    key: "$CI_BUILD_REF_NAME"
    paths:
      - node_modules/
    policy: pull
  artifacts:
    paths:
      - dist/lib/

doc:
  stage: test
  script:
    - echo "Génération de la documentation"
    - npm run doc
  cache:
    untracked: true
    key: "$CI_BUILD_REF_NAME"
    paths:
      - node_modules/
    policy: pull
  artifacts:
    paths:
      - documentation/

test:
  stage: test
  script:
    - echo "Tests unitaires"
    - npm run test:coverage
  cache:
    untracked: true
    key: "$CI_BUILD_REF_NAME"
    paths:
      - node_modules/
    policy: pull
  artifacts:
    paths:
      - coverage/

deploy:
  stage: deploy
  script:
    - echo "Deploy a review app"
    - mkdir -p /deployed/$CI_PROJECT_NAME
    - rm -rf /deployed/$CI_PROJECT_NAME/$CI_COMMIT_REF_NAME
    - cp -r dist/ /deployed/$CI_PROJECT_NAME/$CI_COMMIT_REF_NAME
    - cp -r coverage/ /deployed/$CI_PROJECT_NAME/$CI_COMMIT_REF_NAME/coverage
    - cp -r documentation/ /deployed/$CI_PROJECT_NAME/$CI_COMMIT_REF_NAME/documentation

  environment:
    name: $CI_COMMIT_REF_NAME
    url: http://frparrffgitlab.corp.capgemini.com:9080/$CI_PROJECT_NAME/$CI_COMMIT_REF_NAME/index.html
  dependencies:
    - build-app
  cache:
    untracked: true
    key: "$CI_BUILD_REF_NAME"
    paths:
      - node_modules/
    policy: pull

deploy_doc:
  stage: deploy
  script:
    - echo "Déploiement de la documentation"
    - npm run doc
    - mkdir -p /deployed/$CI_PROJECT_NAME
    - rm -rf /deployed/$CI_PROJECT_NAME/$CI_COMMIT_REF_NAME/documentation
    - cp -r documentation/ /deployed/$CI_PROJECT_NAME/$CI_COMMIT_REF_NAME/documentation
  environment:
    name: master_doc
    url: http://frparrffgitlab.corp.capgemini.com:9080/$CI_PROJECT_NAME/$CI_COMMIT_REF_NAME/documentation/index.html
  only:
    - master
  dependencies:
    - doc
  cache:
    untracked: true
    key: "$CI_BUILD_REF_NAME"
    paths:
      - node_modules/
    policy: pull


deploy_coverage:
  stage: deploy
  script:
    - echo "Déploiement de la couverture de test"
    - npm run doc
    - mkdir -p /deployed/$CI_PROJECT_NAME
    - rm -rf /deployed/$CI_PROJECT_NAME/$CI_COMMIT_REF_NAME/coverage
    - cp -r coverage/ /deployed/$CI_PROJECT_NAME/$CI_COMMIT_REF_NAME/coverage
  environment:
    name: master_coverage
    url: http://frparrffgitlab.corp.capgemini.com:9080/$CI_PROJECT_NAME/$CI_COMMIT_REF_NAME/coverage/index.html
  only:
    - master
  dependencies:
    - test
  cache:
    untracked: true
    key: "$CI_BUILD_REF_NAME"
    paths:
      - node_modules/
    policy: pull

